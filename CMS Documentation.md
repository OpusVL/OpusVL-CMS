# Introduction

## Concepts

The Flexibase CMS operates at a relatively ”low-level” compared with
other content management tools; for example, there are no built-in
facilities for defining page navigation, it does not enforce any
specific site structure, and so on. This gives a huge amount of
flexibility to create any style of site (e.g. Blog, photo gallery,
shopping cart, brochure, etc) without being constrained by limitations
of the software.

At its core, there are five different types of content that can be
managed; Pages, Templates, Assets, Elements, and Attachments. These are
linked together by a powerful tagging system to record metadata about
these objects, and a templating engine which provides detailed querying
and decision making abilities.

## Objects

The structure of the CMS is made up of Pages, Attachments, Elements,
Templates, and Assets. These are linked together using Tags, which allow
metadata such as categories to be added.

**Pages** are the core of the CMS. Each page has a URL, Title, Content,
and other attributes. Any files (images, documents, etc) may be added as
attachments to a page.

**Elements** are chunks of content which can be dynamically included
within a page or a template. These are particularly useful if a piece of
content needs to be re-used, e.g. a breadcrumb trail that needs to be
shared between multiple templates.

**Assets** are non-HTML content (images, CSS files, JavaScript, etc)
which are available ’site-wide’, i.e. they are not attached to a
specific page. Assets can be uploaded by dragging & dropping files into
the editor. Once they have been uploaded, text-based assets (CSS and
JavaScript) can be edited in-line using the GUI.

**Templates** control the ’look and feel’ of Pages

**Tags** allow arbitrary metadata to be attached to Pages.

## Templating system

Pages, Elements, and Templates are processed using the Template Toolkit
templating system. Template Toolkit (often referred to as TT) provides
flow control, macros, formatting, and the ability to query the CMS and
other data sources. For example, a breadcrumb trail or navigation bar
can be generated by querying the CMS for pages that match a certain
criteria and then formatting the results.

The TT documentation (detailing all built-in directives, methods, and
syntax) is available at
<http://template-toolkit.org/docs/manual/index.html>.

## Version control

Whenever the content of a Page, Element, Asset, Attachment, or Template
is edited, a new version is stored in the database. It is therefore
possible to revert to previous versions to ’undo’ any changes.

# Documentation

## Templates

Templates provide the main page rendering function, i.e. the control
flow that starts when a page is accessed. Generally a template will
contain the main "skin" of the site, including assets (e.g. CSS /
JavaScript / images) and elements (such as navigation bars).

### Template Toolkit

The templates use the Template Toolkit (TT) language, which includes
many built-in functions for flow control, formatting, etc). The full TT
documentation is available here:

[`http://template-toolkit.org/docs/manual/index.html`](http://template-toolkit.org/docs/manual/index.html)

and more here:

[`http://www.stonehenge.com/merlyn/LinuxMag/col61.html`](http://www.stonehenge.com/merlyn/LinuxMag/col61.html)

### Rendering page content

To render the page, the template must call

`[% PROCESS content %]`

either in the main template or via an included element.

Other page attributes can be accessed using `[% me %]`, e.g.

<title>
[% me.title %]

</title>
`<h1>[% me.h1 %]</h1>`

## Directives and Commands

The following directives can be used within pages, templates, or
elements.

`[% me %]`: Contains the page object for the current page being rendered. `[% me %]` has all of the standard page attributes documented in [Flexibase CMS Reference - Pages](Flexibase CMS Reference - Pages "wikilink").

`[% cms.asset %]`:Returns the URL of an asset by its ID, e.g. `[% cms.asset(5) %]`.

`[% cms.attachment %]`:Returns the URL of an attachment by its ID, e.g. `[% cms.attachment(3) %]`.

`[% cms.element %]`:Used to embed an element within another element, template, or page. Must be followed by "`| eval`", e.g. `[% element(6) | eval %]`.

`[% cms.page %]`:Retrieves a page object by ID, e.g. `[% cms.page(11) %]`. Has all of the standard page attributes documented in [Flexibase CMS Reference - Pages](Flexibase CMS Reference - Pages "wikilink"), e.g. `[% cms.page(11).breadcrumb %]`.

`[% cms.param %]`:Returns a query string parameter by name, e.g. `[% cms.param('q') %]` will address the query string <http://domain.com/page?q=abc>

`[% cms.search %]`:Not yet implemented. Will search the CMS for pages, tags, attachments matching specified criteria.

`[% cms.thumbnail %]`: Returns a URL for a thumbnail image of an asset or an attachment. Documented in [Flexibase CMS Reference - Thumbnails](Flexibase CMS Reference - Thumbnails "wikilink").

`[% c.uri_for(me.url) %]`: provides current URL

### If

    [% IF (cms.param('contact_form_submit') eq 'success' ) %]
     <h3> It worked></h3>
    [% ELSIF (cms.param('contact_form_submit') eq 'missing_fields' ) %]
     <h3> It didnt ..></h3>
    [% ELSE %]
     <h3> Something else</h3>
    [% END %]   

### Foreach

`[% FOREACH page IN me.tree %]`\
`    [% UNLESS loop.last %]`\
`      `<a href="[% c.uri_for(page.url) %]">`[% page.breadcrumb %]`</a>\
`      >`\
`    [% ELSE %]`\
`      [% page.breadcrumb %]`\
`    [% END %]`\
`  [% END %]`


## Pages

### Properties

Within a template, page, or asset, the current page is always available
as `[% me %]`. So the following properties can be accessed as
`[% me.title %]`, `[% me.description %]`, etc.

-   me.parent - returns parent page object - anything you can do on me.
    can be done on me.parent, me.parent.title for example
-   id - internal ID of the page
-   url - URL path, does not include domain name (e.g.
    /products/flexibase)
-   h1 - page heading
-   title - page title
-   priority - page priority, used for sorting
-   breadcrumb - name to appear in navigation / breadcrumb trails
-   description - free text field, can be used in the \<meta
    description=""\> tag
-   created - when was the page created (DateTime object)
-   updated - when was the page last updated (DateTime object)
-   contents - the main page content
-   tree - list the page hierarchy, starting with the home page
-   children - returns all direct child pages, sorted by priority
-   descendants - returns all page descendants
-   attachments - returns list of attached files
-   page\_tags - returns a hash of all tags directly applied to the page
-   cascaded\_tags - returns a hash of all tags inherited from parent
    pages
-   tags - returns a hash of all page tags (combination of page\_tags
    and cascaded\_tags)

#### Examples

Loop through all attachments

`<ul>`\
`   [% FOREACH file IN me.attachments %]`\
`     <li><a href="[% cms.attachment(file.id, file.filename) %]">[% file.filename %]</a> [% file.description %]`\
`   [% END %]`\
` </ul>`

React differently to every other item in the loop

	[% IF loop.odd %]

Show when the page was updated

	Page last changed on [% me.updated.strftime("%A, %d %B %Y") %].

### Links

To link to a page, use the `[% cms.page(id) %]` directive - this will
continue to work if the URL of the target page changes.

#### Examples

Link with default text

	<a href="[% cms.page(11).url %]">[% cms.page(11).breadcrumb %]</a>

Link with custom text

	<a href="[% cms.page(11).url %]">Aquarius</a>

### Searching pages

**Note that the exact syntax here is subject to change as we use and
develop the CMS**

#### Examples

Loop through all pages with the tag "Topic = Perl"

`[% FOREACH page IN c.model('CMS::TagGroups').search({'name' => 'Topic'}).search_related('tags', {'name' => 'Perl'}).pages %]`\
`   <a href="[% page.url %]">[% page.breadcrumb %]</a> `\
` [% END %]`

Show the 5 most recent updates to the site

`<ul>`\
`   [% FOREACH page IN c.model('CMS::Pages').search({'status' => 'published'},{'order_by' => {'-desc' => 'updated'}, 'rows' => 5}) %]`\
`     <li><a href="[% page.url %]">[% page.breadcrumb %]</a> - updated on [% page.updated.dmy %]`\
`   [% END %]`\
` </ul>`

## Variables

### Setting

#### Transient (in-page) variables

Set:

`[% SET var = 'val' %]`

Get:

`[% var %]`

These variables are discarded once the page is loaded so valid to be set
within a page, and referenced within the same page.

#### Persistent (session) variables

Set:

`[% c.session.variable_name = "variable value" %] `

Get:

`[% c.session.variable_name %]`

These variables last for the length of the session, and are then
discarded, so can be set in any page and read in any other, until the
session expires.

#### Persistent (Site) variables

Set:

`TBA`

Get:

`TBA`

These variables will persist until removed.

### Built-in readable variables

Print the current date:

`[% date.format %]`

For example, print the year:

`[% date.format.strftime("%A, %Y") %]`


# Examples
## Breadcrumb trail

Generating a breadcrumb trail is quite simple as the CMS uses a
hierarchical structure. The trail loops through the page tree from start
to finish, rendering a link for all but the last element (i.e. the
current page). The `breadcrumb` attribute of each page is used as the
link text.

`<div class="breadcrumb">`\
`   [% FOREACH page IN me.tree %]`\
`     [% UNLESS loop.last %]`\
`       <a href="[% c.uri_for(page.url) %]">[% page.breadcrumb %]</a>`\
`       &gt;`\
`     [% ELSE %]`\
`       [% page.breadcrumb %]`\
`     [% END %]`\
`   [% END %]`\
` </div>`

## Navigation

Many sites use a primary / secondary navigation structure, where the
primary navigation splits the site into top-level sections, and the
secondary navigation lists the main pages within a specific section.

The primary and secondary navigation elements may be rendered separately
(e.g. a top bar and a side bar) or together (e.g. drop-down menus).

The examples here output the navigation links as HTML list elements
which can be easily styled using CSS (e.g. to display a horizontal
navigation bar).

### Tags

The key to making this work is setting the correct tags to the top-level
pages, and ensuring that the site follows a clear hierarchy.

Start by creating a tag called "Section" with the attributes
`Cascade = Yes` and `Multiple = No`. Then add values to this tag
corresponding to the high level sections of your site. The attributes
set for this tag mean that pages can only be part of a single section,
and child pages will inherit their section from the parent page.

### Primary navigation

The page `breadcrumb` attribute is used as the link text. The current
section is highlighted using HTML 'strong' tags.

`<div id="primary_navigation">`\
`   <ul>`\
`     [% FOREACH page IN c.model("CMS::TagGroups").find({"name" => "Section"}).tagged_pages %]`\
`       [% IF (me.tags.Section == page.tags.Section) %]<strong>[% END %]`\
`       <li><a href="[% c.uri_for(page.url) %]">[% page.breadcrumb %]</a>`\
`       [% IF (me.tags.Section == page.tags.Section) %]</strong>[% END %]`\
`     [% END %]`\
`   </ul>`\
` </div>`

### Secondary navigation

This works by locating the first page directly tagged with the current
section name, then rendering a list of its direct children.

`<div id="secondary_navigation">`\
`   <ul>`\
`     [% FOREACH page IN c.model('CMS::TagGroups').find({"name" => "Section"}).find_related("tags", {"name" => me.tags.Section}).tagged_pages.first.children %]`\
`       <li><a href="[% c.uri_for(page.url) %]">[% page.breadcrumb %]</a>`\
`     [% END %]`\
`   </ul>`\
` </div>`

## Thumbnails

The Flexibase CMS includes a module to generate thumbnail images in any
size from site Assets or page Attachments. The GUI editor includes a
button to generate thumbnail tags from these elements.

### Usage

The `[% cms.thumbnail() %]` directive returns the URL for the thumbnail
image, so you can use this directive in `&lt;img&gt;` tags or
stylesheets.

Arguments to `cms.thumbnail()` are the object type (asset or
attachment), the object ID or slug, and optional parameters (e.g. to
specify the size of the thumbnail).

### Examples

Render a thumbnail for a page attachment.

	<img src="[% cms.thumbnail('attachment',1) %]">

or use the slug instead of the attachment ID:

	<img src="[% cms.thumbnail('attachment','logo') %]">

Render a thumbnail for a site asset.

	<img src="[% cms.thumbnail('asset',1) %]">

Specify the height of a thumbnail image (the width will be calculated
automatically)

	<img src="[% cms.thumbnail('attachment',1, {'y' => 100}) %]">

Specify the width of a thumbnail image (the height will be calculated
automatically)

	<img src="[% cms.thumbnail('attachment',1, {'x' => 100}) %]">

Specify the width and height of a thumbnail image (the image will be
cropped if necessary)

	<img src="[% cms.thumbnail('attachment',1, {'x' => 100, 'y' => 100}) %]">

Produce a 'zoomed-in' thumbnail (using the middle 75% of the original
image)

	<img src="[% cms.thumbnail('attachment',1, {'zoom' => 75}) %]">

Options can be combined, e.g. to produce a square zoomed in thumbnail

	<img src="[% cms.thumbnail('attachment',1, {'x' => 100, 'y' => 100, 'zoom' => 80}) %]">

## Error pages

### 404 - Page not found

The 404 page is generated if a page URL cannot be found.

To use a custom page for 404 errors, simply create a page in the CMS
with a URL of **/404** - this will then be used to display any page not
found errors.

### 500 - Internal server error

Error 500 pages will be generated if one of the templates, pages, or
elements cannot be parsed.

